<!doctype html>
<html>
<head>
    <title>Argon Tests</title>    
    <script src="/jspm_packages/system.src.js"></script>
    <script src="/jspm.browser.js"></script>
    <script src="/jspm.config.js"></script>
</head>
<body>
    <div id="mocha"></div>
    <script>
        System.import('istanbul/lib/instrumenter.js').then(function(Instrumenter) {
            // A map from argon source file names to their source maps
            var sourceMaps = {};
            // A map from argon source file names to their transpiled js
            var sourceJs = {};

            // Override the systemjs translate function so that our typescript
            // is instrumented by istanbul for code coverage.
            //
            // TODO: It's probably possible to avoid this by modifying the meta
            // property of SystemJS for our files to use a custom plugin which
            // does this.
            var oldSystemTranslate = System.translate;
            System.translate = function(load) {
                var result = oldSystemTranslate.call(this, load);

                var matchResult = /((?:src|test)\/.*)\.ts$/.exec(load.address);
                if (matchResult !== null) {
                    var fileName = matchResult[1];
                    var baseFileName = fileName.slice(fileName.lastIndexOf('/') + 1)

                    result = result.then(function(code) {
                        var codeWithSourceMapComment = '//# sourceMappingURL=' + baseFileName + '.js.map\n' + code;

                        sourceJs[fileName + '.js'] = codeWithSourceMapComment;
                        sourceMaps[fileName + '.js.map'] = load.metadata.sourceMap;
                        sourceMaps[fileName + '.js.map'].sources = [baseFileName + '.ts'];

                        load.source = new Instrumenter().instrumentSync(codeWithSourceMapComment, fileName + '.js');
                        // TODO: should also update load.sourceMap
                        return load.source;
                    });
                }

                return result;
            }

            // Setup mocha
            System.import('mocha').then(function(mocha) {
                mocha.setup('bdd');

                // Run tests with mocha
                System.import('test/test.ts!').then(function() {
                    mocha.checkLeaks();
                    mocha.run(function() {
                        window.___browserSync___.socket.emit('argon:coverage', {
                            coverage: window.__coverage__,
                            sourceMaps: sourceMaps,
                            sourceJs: sourceJs
                        });
                    });
                });
            });
        });
    </script>
</body>
</html>
